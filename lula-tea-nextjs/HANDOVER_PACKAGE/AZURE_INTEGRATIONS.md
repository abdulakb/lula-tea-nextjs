# Azure Services Integration Documentation

> **SECURITY NOTE**: This document contains placeholder values for sensitive credentials. Actual API keys and connection strings can be found in:
> - Local development: `.env.local` file
> - Production: Vercel Environment Variables dashboard
> - Source: Azure Portal for each service
> 
> **Never commit API keys to Git repositories**

## Table of Contents
1. [Azure OpenAI GPT-4o](#azure-openai-gpt-4o)
2. [Azure Application Insights](#azure-application-insights)
3. [Smart Response System](#smart-response-system)
4. [M365 Copilot Create Assets](#m365-copilot-create-assets)
5. [Environment Variables](#environment-variables)
6. [Cost Management](#cost-management)
7. [Maintenance](#maintenance)
8. [Troubleshooting](#troubleshooting)
9. [Security Best Practices](#security-best-practices)

---

## Azure OpenAI GPT-4o

### Service Details
- **Resource Name**: gpt100
- **Endpoint**: `https://gpt100.services.ai.azure.com`
- **Deployment Name**: `gpt-4o`
- **API Version**: `2024-08-01-preview`
- **API Key**: `[REDACTED - Check .env.local or Vercel Environment Variables]`

### Configuration
```typescript
// lib/supabaseClient.ts
const configuration = {
  apiKey: process.env.AZURE_OPENAI_API_KEY,
  endpoint: "https://gpt100.services.ai.azure.com",
  deployment: "gpt-4o",
  apiVersion: "2024-08-01-preview"
};
```

### System Prompt
The assistant is configured with comprehensive business knowledge:
- **Product Catalog**: All Lula Tea products with pricing
- **Sabbabeen Services**: Coffee/tea serving packages
- **Ordering Process**: Website walkthrough
- **Language Support**: Bilingual Arabic/English
- **WhatsApp Integration**: Order updates via WhatsApp

### Features Implemented
- ✅ Smart chat widget on all pages
- ✅ Product recommendations
- ✅ Order assistance
- ✅ Sabbabeen service inquiries
- ✅ Bilingual support (Arabic/English)
- ✅ Context-aware responses

### Testing
```bash
# Test the API endpoint
curl https://gpt100.services.ai.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-08-01-preview \
  -H "api-key: [YOUR_API_KEY]" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

---

## Azure Application Insights

### Service Details
- **Resource Name**: lula-tea-insights
- **Region**: Sweden Central
- **Connection String**: `[REDACTED - Check .env.local or Vercel Environment Variables]`
- **Instrumentation Key**: `[REDACTED - See Azure Portal]`

### Events Tracked
1. **AddToCart**
   - Properties: `productName`, `quantity`, `price`
   - Context: Cart operations

2. **CheckoutStarted**
   - Properties: `cartTotal`, `itemCount`
   - Context: Checkout page load

3. **ChatMessageSent**
   - Properties: `messageLength`, `language`
   - Context: AI assistant interactions

4. **OrderCompleted**
   - Properties: `orderId`, `totalAmount`, `paymentMethod`
   - Context: Successful order placement

5. **ReviewSubmitted**
   - Properties: `rating`, `hasComment`
   - Context: Customer feedback

### Dashboard Access
1. Go to Azure Portal: https://portal.azure.com
2. Navigate to "lula-tea-insights" resource
3. View real-time analytics in "Logs" section
4. Create custom dashboards with KQL queries

### Sample Queries
```kql
// Top 5 products added to cart (last 7 days)
customEvents
| where name == "AddToCart"
| where timestamp > ago(7d)
| summarize count() by tostring(customDimensions.productName)
| top 5 by count_

// Chat interactions by language
customEvents
| where name == "ChatMessageSent"
| summarize count() by tostring(customDimensions.language)

// Order completion rate
let checkouts = customEvents | where name == "CheckoutStarted" | count;
let orders = customEvents | where name == "OrderCompleted" | count;
print CompletionRate = todouble(orders) / todouble(checkouts) * 100
```

### Cost & Limits
- **Tier**: Free (5 GB/month)
- **Data Retention**: 90 days
- **Current Usage**: Check Azure Portal → Metrics → Data Volume

---

## Smart Response System

### Admin Tool
Located in: `app/admin/page.tsx`

**Purpose**: Add custom FAQ responses to improve AI assistant accuracy

**Usage**:
1. Navigate to `/admin` (requires Supabase auth)
2. Enter question/answer pairs
3. AI assistant will prioritize these custom responses
4. Reduces API costs by caching common queries

**Database**: Stored in Supabase `smart_responses` table

---

## M365 Copilot Create Assets

### Story Carousel Images
**Location**: `/public/images/story/`
- `slide-1.png` - Our Beginning
- `slide-2.png` - The Discovery
- `slide-3.png` - The Challenge
- `slide-4.png` - The Mission
- `slide-5.png` - The Vision
- `slide-6.png` - The Invitation

**Specifications**:
- Generated by: M365 Copilot Create
- Theme: Saudi winter aesthetic
- Dimensions: Optimized for web display
- Text: Bilingual (baked into images)

### Tea Brewing Tutorial Video
**Location**: `/public/videos/tea-brewing-tutorial.mp4`
- Size: 22.58 MB
- Generated by: M365 Copilot Create
- Theme: Saudi winter traditional tea brewing
- Duration: ~1 minute
- Used on: Homepage hero section

---

## Environment Variables

### Vercel Environment Variables
All environment variables must be set in **Vercel Dashboard** → **Settings** → **Environment Variables**

```bash
# Azure OpenAI
AZURE_OPENAI_API_KEY=[Your Azure OpenAI API Key - See Azure Portal]
AZURE_OPENAI_ENDPOINT=https://gpt100.services.ai.azure.com
AZURE_OPENAI_DEPLOYMENT=gpt-4o

# Application Insights
NEXT_PUBLIC_APPINSIGHTS_CONNECTION_STRING=[Your Connection String - See Azure Portal]

# Supabase
NEXT_PUBLIC_SUPABASE_URL=[Your Supabase Project URL]
NEXT_PUBLIC_SUPABASE_ANON_KEY=[Your Supabase Anon Key]

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=[Your Stripe Publishable Key]
STRIPE_SECRET_KEY=[Your Stripe Secret Key]

# Resend Email
RESEND_API_KEY=[Your Resend API Key]

# WhatsApp Business
WHATSAPP_TOKEN=[Your WhatsApp Business API Token]
WHATSAPP_PHONE_NUMBER_ID=[Your Phone Number ID]
WHATSAPP_BUSINESS_ACCOUNT_ID=[Your Business Account ID]
WHATSAPP_VERIFY_TOKEN=[Your Custom Verify Token]
```

### Local Development (.env.local)
Create `.env.local` file in project root with the same variables above.

**IMPORTANT**: `.env.local` is in `.gitignore` - never commit it to Git

---

## Cost Management

### Azure OpenAI Costs
- **Model**: GPT-4o
- **Pricing**: ~$0.005 per 1K input tokens, ~$0.015 per 1K output tokens
- **Estimated Monthly**: $10-30 (depends on chat volume)

### Application Insights Costs
- **Tier**: Free (5 GB/month)
- **Expected Usage**: <1 GB/month
- **Cost**: $0

### Optimization Tips
1. Use Smart Response System to cache common questions
2. Implement rate limiting on chat widget
3. Monitor token usage in Azure Portal
4. Set budget alerts in Azure

---

## Maintenance

### Monthly Tasks
- [ ] Review Application Insights dashboard
- [ ] Check Azure OpenAI usage and costs
- [ ] Update Smart Response System with new FAQs
- [ ] Review chat logs for improvements
- [ ] Verify M365 Copilot assets are loading correctly

### Quarterly Tasks
- [ ] Audit API key rotation (security best practice)
- [ ] Review and optimize system prompts
- [ ] Analyze customer behavior patterns
- [ ] Update business knowledge in AI assistant

---

## Troubleshooting

### Chat Widget Not Working
**Symptom**: Widget visible but no responses

**Check**:
1. Verify `AZURE_OPENAI_API_KEY` in Vercel
2. Check API endpoint is correct: `https://gpt100.services.ai.azure.com`
3. Look for errors in browser console
4. Verify deployment name: `gpt-4o`

**Solution**: Redeploy from Vercel dashboard after fixing env vars

### Application Insights Not Tracking
**Symptom**: No events in Azure Portal

**Check**:
1. Verify `NEXT_PUBLIC_APPINSIGHTS_CONNECTION_STRING` is set
2. Check browser console for AppInsights errors
3. Ensure events are being sent (check Network tab)

**Solution**: 
```typescript
// Test event manually in browser console
window.appInsights?.trackEvent({
  name: "TestEvent",
  properties: { test: "value" }
});
```

### M365 Assets Not Loading
**Symptom**: Story carousel or video broken

**Check**:
1. Verify files exist in `/public/images/story/` and `/public/videos/`
2. Check file sizes (22.58 MB for video)
3. Look for 404 errors in Network tab

**Solution**: Re-deploy or manually upload files to Vercel

### API Key Exposed in Git
**Symptom**: GitHub push protection triggered

**Solution**:
1. Immediately rotate the exposed key in Azure Portal
2. Update `.env.local` and Vercel with new key
3. Remove key from Git history:
```bash
git reset --hard HEAD~[number_of_commits]
# Or use git filter-branch for deep cleaning
```

---

## Security Best Practices

1. **Never commit API keys** to Git repositories
2. **Rotate keys regularly** (every 90 days minimum)
3. **Use environment variables** for all sensitive data
4. **Enable Azure Key Vault** for production (optional enhancement)
5. **Set up alerts** for unusual API usage patterns
6. **Implement rate limiting** on public endpoints
7. **Use HTTPS only** for all API calls
8. **Monitor Azure Portal** for security recommendations

---

## Support Resources

### Azure OpenAI
- Documentation: https://learn.microsoft.com/azure/ai-services/openai/
- Pricing: https://azure.microsoft.com/pricing/details/cognitive-services/openai-service/

### Application Insights
- Documentation: https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview
- KQL Reference: https://learn.microsoft.com/azure/data-explorer/kusto/query/

### M365 Copilot Create
- Documentation: https://support.microsoft.com/copilot
- Asset Management: Microsoft 365 Admin Center

### Contact
For Azure support: Azure Portal → Help + Support → New Support Request

---

**Document Version**: 1.0  
**Last Updated**: January 2025  
**Maintained By**: Development Team
